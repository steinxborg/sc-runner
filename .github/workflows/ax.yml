name: ax
on:
#   schedule:
#     - cron: "*/30 * * * *"
  workflow_dispatch:
# Use workflow-specific concurrency group to prevent cancellation
# GitHub cancels waiting scheduled runs if newer ones arrive with same group
concurrency:
  group: ax-repo-update  # Make this unique per workflow
  cancel-in-progress: false
jobs:
  fetch_data:
    runs-on: ubuntu-latest
    env:
      REPO_FOLDER: ax-repo
      SCRIPT_NAME: ax.py
      OUTPUT_FILE: ax.json
      ENRICHED_FILE: ax-enriched.json
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Clone target repo
        run: |
          git clone https://${{ secrets.SCRAPER_TOKEN }}@github.com/${{ secrets.SCRAPER_REPO }} $REPO_FOLDER
      
      - name: Run Script, Commit and Push with Retry
        run: |
          cd $REPO_FOLDER
          git config user.name "actions-user"
          git config user.email "actions@github.com"
          
          # Detect default branch
          DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
          
          # Run the script ONCE and save outputs to a temp location outside the repo
          python $SCRIPT_NAME
          cp $OUTPUT_FILE /tmp/$OUTPUT_FILE
          cp $ENRICHED_FILE /tmp/$ENRICHED_FILE
          
          # Retry loop for push conflicts (up to 5 attempts)
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"
            
            # Fetch latest remote state and reset to it
            git fetch origin $DEFAULT_BRANCH
            git reset --hard origin/$DEFAULT_BRANCH
            
            # Re-apply the already-generated output files (no re-running the script)
            cp /tmp/$OUTPUT_FILE $OUTPUT_FILE
            cp /tmp/$ENRICHED_FILE $ENRICHED_FILE
            
            # Stage the changes
            git add $OUTPUT_FILE $ENRICHED_FILE
            
            if git diff --cached --quiet; then
              echo "No changes after sync with remote"
              exit 0
            fi
            
            git commit -m "Update $OUTPUT_FILE [${SCRIPT_NAME}-$(date -u +%Y%m%d-%H%M%S)]"
            
            if git push origin HEAD:$DEFAULT_BRANCH; then
              echo "✓ Successfully pushed changes"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              SLEEP_TIME=$((2 ** RETRY_COUNT + RANDOM % 5))
              echo "Push failed, waiting ${SLEEP_TIME}s before retry..."
              sleep $SLEEP_TIME
            fi
          done
          
          echo "✗ Failed to push after $MAX_RETRIES attempts"
          exit 1
